{% extends 'base.html' %}

{% block title %}Flask Markdown博客{% endblock %}

{% block content %}
    <h2>最新文章</h2>
    
    <!-- 搜索和筛选区域 -->
    <div class="search-filter">
        <form method="GET" action="/" class="search-form">
            <input type="text" name="search" placeholder="搜索文章..." value="{{ search_query }}">
            <button type="submit" class="btn btn-submit">搜索</button>
            {% if search_query or selected_tag %}
                <a href="/" class="btn btn-cancel">清除筛选</a>
            {% endif %}
        </form>
        
        <!-- 标签云 -->
        <div class="tag-cloud">
            <h3>文章标签</h3>
            <div class="tags">
                {% if all_tags %}
                    {% for tag in all_tags %}
                        <a href="/?tag={{ tag.name }}" 
                           class="tag {% if tag.name == selected_tag %}selected{% endif %}">
                            {{ tag.name }}
                        </a>
                    {% endfor %}
                {% else %}
                    <p>暂无标签</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- 结果提示 -->
    {% if search_query %}
        <p class="search-results">搜索结果: "{{ search_query }}"</p>
    {% endif %}
    {% if selected_tag %}
        <p class="search-results">标签筛选: "{{ selected_tag }}"</p>
    {% endif %}

    <!-- 文章列表 -->
    {% if posts %}
        <div class="posts">
            {% for post in posts %}
                <article class="post-preview">
                    <h3><a href="{{ url_for('post', post_id=post.id) }}">{{ post.title }}</a></h3>
                    <div class="post-meta">
                        <time datetime="{{ post.created_at }}">{{ post.created_at }}</time>
                        {% if post.username %}
                            <span class="author">作者: {{ post.username }}</span>
                        {% endif %}
                        
                        <!-- 显示文章标签 -->
                        {% if post.tags %}
                            <div class="post-tags">
                                {% for tag in post.tags %}
                                    <a href="/?tag={{ tag.name }}" class="tag-small">{{ tag.name }}</a>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="post-content-preview">{{ post.content_html|first_five_lines|safe }}</div>
                    <div class="post-actions">
                        <a href="{{ url_for('post', post_id=post.id) }}" class="btn btn-readmore">阅读全文</a>
                        {% if session.user_id == post.author_id %}
                            <a href="{{ url_for('edit', post_id=post.id) }}" class="btn btn-edit">编辑</a>
                        {% endif %}
                    </div>
                </article>
            {% endfor %}
        </div>
        
        <!-- 分页导航 -->
        {% if total_pages > 1 %}
        <div class="pagination">
            <div class="pagination-info">
                显示 {{ (page-1)*per_page + 1 }}-{{ page*per_page if page*per_page <= total else total }} 条，共 {{ total }} 条
            </div>
            <div class="pagination-controls">
                <!-- 上一页 -->
                {% if page > 1 %}
                    <a href="{% if search_query %}{{ url_for('index', search=search_query, tag=selected_tag, page=page-1) }}{% elif selected_tag %}{{ url_for('index', tag=selected_tag, page=page-1) }}{% else %}{{ url_for('index', page=page-1) }}{% endif %}" class="btn btn-page">&laquo; 上一页</a>
                {% else %}
                    <span class="btn btn-page disabled">&laquo; 上一页</span>
                {% endif %}
                
                <!-- 页码 -->
                {% for p in range(1, total_pages + 1) %}
                    <!-- 只显示当前页附近的页码 -->
                    {% if p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                        {% if p == page %}
                            <span class="btn btn-page current">{{ p }}</span>
                        {% else %}
                            <a href="{% if search_query %}{{ url_for('index', search=search_query, tag=selected_tag, page=p) }}{% elif selected_tag %}{{ url_for('index', tag=selected_tag, page=p) }}{% else %}{{ url_for('index', page=p) }}{% endif %}" class="btn btn-page">{{ p }}</a>
                        {% endif %}
                    {% elif p == page - 3 or p == page + 3 %}
                        <span class="btn btn-page">...</span>
                    {% endif %}
                {% endfor %}
                
                <!-- 下一页 -->
                {% if page < total_pages %}
                    <a href="{% if search_query %}{{ url_for('index', search=search_query, tag=selected_tag, page=page+1) }}{% elif selected_tag %}{{ url_for('index', tag=selected_tag, page=page+1) }}{% else %}{{ url_for('index', page=page+1) }}{% endif %}" class="btn btn-page">下一页 &raquo;</a>
                {% else %}
                    <span class="btn btn-page disabled">下一页 &raquo;</span>
                {% endif %}
            </div>
        </div>
        {% endif %}
    {% else %}
        <p class="no-posts">暂无文章</p>
    {% endif %}
{% endblock %}